<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music App</title>

    <!-- External CSS -->
    <link rel="stylesheet" href="style.css">

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>

    <!-- YouTube API -->
    <script src="https://www.youtube.com/iframe_api"></script>
</head>
<body>
    <!-- Top Container -->
    <div id="top-container">
        <!-- Left: YouTube Player & Controls -->
        <div id="left-container">
            <div id="player-container">
                <div id="player"></div> <!-- YouTube Player Goes Here -->
            </div>

            <!-- Search -->
            <div id="search-container">
                <input type="text" id="search-input" placeholder="Search for songs...">
                <button id="search-button">Search</button>
                <div id="search-results"></div> <!-- Search Results Appear Here -->
            </div>

            <!-- Controls -->
            <div id="controls-container">
                <div id="seek-bar-container">
                    <button id="prev-btn">⏮️</button>
                    <input type="range" id="seek-bar" min="0" value="0">
                    <button id="next-btn">⏭️</button>
                </div>
                <button id="play-pause-btn">▶️</button>
            </div>
        </div>

        <!-- Right: Sign-In -->
        <div id="auth-container">
            <button id="login-btn">Sign in with Google</button>
            <button id="logout-btn" style="display: none;">Sign out</button>
        </div>
    </div>

    <!-- Playlist (Visible to Everyone) -->
    <div id="playlist-container">
        <h2>Playlist</h2>
        <ul id="playlist"></ul>
    </div>

    <script>
        let player;
        let playlist = [];
        let currentIndex = 0;

        // Ensure YouTube API Loads Correctly
        function onYouTubeIframeAPIReady() {
            console.log("YouTube API Ready");
            player = new YT.Player('player', {
                height: '225',
                width: '400',
                videoId: '',
                playerVars: { 'autoplay': 0, 'controls': 1 },
                events: {
                    'onReady': () => console.log("YouTube Player Loaded"),
                    'onStateChange': syncPlayback
                }
            });
        }

        document.addEventListener("DOMContentLoaded", function () {
            console.log("DOM Loaded");

            // Play/Pause Button
            document.getElementById("play-pause-btn").addEventListener("click", function () {
                if (player && player.getPlayerState() === 1) {
                    player.pauseVideo();
                    this.innerText = "▶️";
                } else if (player) {
                    player.playVideo();
                    this.innerText = "⏸️";
                }
            });

            // YouTube Search
            document.getElementById("search-button").addEventListener("click", function () {
                const query = document.getElementById("search-input").value;
                console.log("Searching:", query);

                fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${query}&type=video&key=AIzaSyBFfY5CZScu8FdE2oLjaCTQ3H5WbAQXos8`)
                    .then(response => response.json())
                    .then(data => {
                        const resultsContainer = document.getElementById("search-results");
                        resultsContainer.innerHTML = ""; // Clear old results

                        data.items.forEach(item => {
                            const videoId = item.id.videoId;
                            const button = document.createElement("button");
                            button.innerText = item.snippet.title;
                            button.addEventListener("click", function () {
                                currentIndex = playlist.length; // Add to playlist index
                                playlist.push(videoId);
                                player.loadVideoById(videoId);
                                resultsContainer.innerHTML = ""; // Clear search results
                            });

                            resultsContainer.appendChild(button);
                        });

                        console.log("Search Results Displayed");
                    });
            });

            // Next & Previous Buttons
            document.getElementById("next-btn").addEventListener("click", function () {
                if (playlist.length > 0 && currentIndex < playlist.length - 1) {
                    currentIndex++;
                    player.loadVideoById(playlist[currentIndex]);
                }
            });

            document.getElementById("prev-btn").addEventListener("click", function () {
                if (playlist.length > 0 && currentIndex > 0) {
                    currentIndex--;
                    player.loadVideoById(playlist[currentIndex]);
                }
            });

            // Seek Bar
            document.getElementById("seek-bar").addEventListener("input", function () {
                if (player && player.getDuration) {
                    const seekToTime = (this.value / 100) * player.getDuration();
                    player.seekTo(seekToTime, true);
                }
            });

            setInterval(() => {
                if (player && player.getCurrentTime && player.getDuration()) {
                    const progress = (player.getCurrentTime() / player.getDuration()) * 100;
                    document.getElementById("seek-bar").value = progress;
                }
            }, 1000);
        });

        // Sync Playback Function (Placeholder for Firebase Sync)
        function syncPlayback(event) {
            console.log("Playback State Changed:", event.data);
        }
    </script>

</body>
</html>

